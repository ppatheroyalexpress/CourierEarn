name: Build and Release APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create keystore
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
        echo "storeFile=app/release.keystore" >> app/keystore.properties
        echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> app/keystore.properties
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> app/keystore.properties
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> app/keystore.properties

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace --info --no-daemon

    - name: Build Release APK
      run: ./gradlew assembleRelease --stacktrace --info --no-daemon

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 30

    - name: Rename APK files
      run: |
        mv app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/debug/CourierEarn-v1.0-debug.apk
        mv app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/CourierEarn-v1.0.apk

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        name: CourierEarn v1.0 "Yam" - First Public Release
        body: |
          # CourierEarn v1.0 "Yam"
          
          Courier Commission Tracker App for couriers to track daily earnings.
          
          ## âœ¨ Features
          - âœ… Daily Data Entry (Cash Collect 200 MMK, Sender Pay 100 MMK)
          - âœ… Extra Care (EC) Tracking (600 MMK monthly bonus)
          - âœ… Monthly Calculation (1st to last day)
          - âœ… Material Design 3 UI
          - âœ… Calendar View with color-coded days
          - âœ… PDF Export (Weekly & Monthly Reports)
          - âœ… Bluetooth Print (58mm Thermal Printer)
          - âœ… Daily Reminder (8 PM with WorkManager)
          - âœ… Offline-first with Room Database
          - âœ… JSON Backup & Restore
          
          ## ğŸ“± Screenshots
          (Screenshots á€™á€›á€¾á€­á€á€±á€¸á€›á€„á€º á€’á€®á€”á€±á€›á€¬á€™á€¾á€¬á€á€»á€”á€ºá€‘á€¬á€¸á€•á€«)
          
          ## ğŸ“² Installation
          1. Download CourierEarn-v1.0.apk
          2. Enable "Install from unknown sources" in settings
          3. Open APK and install
          4. Start tracking your commissions!
          
          ## ğŸ› ï¸ Technical Details
          - Min SDK: API 21 (Android 5.0+)
          - Target SDK: API 34
          - Architecture: MVVM with Clean Architecture
          - Database: Room
          - Background: WorkManager
          - PDF: iText7
          - Printing: ESC/POS
          
          ## âš ï¸ Disclaimer
          This app is for educational purposes only. Not affiliated with Royal Express Co., Ltd. Actual commission may vary based on company SOP.
          
          ## ğŸ‘¤ Developer
          PPA | 30 (Chanmyathazi East Section)
          
          ---
          
          ## ğŸš€ First Public Release
          
          **Version**: v1.0 "Yam"  
          **Release Date**: ${{ github.event.head_commit.timestamp }}  
          **Status**: Production Ready  
          **Build Type**: Signed Release APK
          
          ### ğŸ“¦ Assets
          - **CourierEarn-v1.0.apk** (Signed Release Build)
          - **CourierEarn-v1.0-debug.apk** (Debug Build for testing)
          
          ### ğŸ“‹ System Requirements
          - Android 5.0 (API 21) or higher
          - 2GB RAM minimum
          - Bluetooth 4.0+ for printing
          - External storage access for exports
          
          ### ğŸ” Permissions Required
          - Bluetooth & Location (for printer)
          - Storage (for PDF export)
          - Notifications (for daily reminders)
          
          ### ğŸ“ Changelog
          **v1.0 "Yam"** - First Public Release
          - Initial release with all core features
          - Daily commission tracking
          - PDF export functionality
          - Bluetooth thermal printer support
          - Daily reminder system
          - Calendar view with data visualization
          - Backup and restore functionality
          
          ---
          
          **Thank you for using CourierEarn! ğŸššğŸ’¨**
          
          *"Yam" - á€¡á€¬á€¸á€›á€™á€¾á€¯áŠ á€…á€Šá€ºá€¸á€…á€Šá€ºá€¸á€œá€¯á€¶á€¸á€œá€¯á€¶á€¸á€–á€¼á€„á€·á€ºá€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸*
        files: |
          app/build/outputs/apk/release/CourierEarn-v1.0.apk
          app/build/outputs/apk/debug/CourierEarn-v1.0-debug.apk
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Get APK info
      run: |
        echo "=== APK Information ==="
        echo "Debug APK Size: $(du -h app/build/outputs/apk/debug/CourierEarn-v1.0-debug.apk | cut -f1)"
        echo "Release APK Size: $(du -h app/build/outputs/apk/release/CourierEarn-v1.0.apk | cut -f1)"
        echo "Build Date: $(date)"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const debugSize = fs.statSync('app/build/outputs/apk/debug/CourierEarn-v1.0-debug.apk').size;
          const releaseSize = fs.statSync('app/build/outputs/apk/release/CourierEarn-v1.0.apk').size;
          
          const comment = `
          ## ğŸš€ Build Successful!
          
          ### ğŸ“¦ APK Files Ready
          - **Debug APK**: ${(debugSize / 1024 / 1024).toFixed(2)} MB
          - **Release APK**: ${(releaseSize / 1024 / 1024).toFixed(2)} MB
          
          ### ğŸ“¥ Download
          Download APK files from the "Artifacts" section below.
          
          ### ğŸ”— Actions
          - [View Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [View Build Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          Build completed in ${{ job.status }} âœ…
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always() && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Notify Release
      run: |
        echo "ğŸ‰ CourierEarn v1.0 'Yam' has been released!"
        echo "ğŸ“± APK is available for download"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v1.0"
